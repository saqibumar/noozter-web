import {Pipe, ElementRef, PipeTransform} from '@angular/core';

@Pipe({
  name: 'unveil'
})
export class UnveilPipe implements PipeTransform  {
  private _margin = 500;
  constructor(private _elementRef: ElementRef) {

  }
  public transform(model: any, amount?: number) {

    if (model.parent && model.index + 1 === model.parent.size) {
      const elm = this._elementRef.nativeElement;
      const checkFn = () => {
        const rects = elm.getBoundingClientRect();
        if (rects.bottom - this._margin < window.innerHeight) {
          window.removeEventListener('scroll', checkFn);
          if (model.nextSet)
            model.nextSet(amount);
          return true;
        } else {
          return false;
        }
      };

      if (!checkFn()) {
        window.addEventListener('scroll', checkFn);
      }
    }
    return '';

  }

}
